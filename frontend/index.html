<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pai Kang Online</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --primary-color: #1b5e20;
      --secondary-color: #0d3b13;
      --accent-color: #ffcc80;
      --text-color: white;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      /* Sostituisco l'immagine di sfondo con un gradiente */
      background: linear-gradient(135deg, #1a472a 0%, #0d3b13 100%);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .game-container {
      display: flex;
      flex: 1;
      padding: 20px;
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    .main-game {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    h1 {
      text-align: center;
      font-size: 2em;
      margin: 10px 0;
      color: var(--text-color);
      text-shadow: 2px 2px 5px black;
    }

    .table {
      position: relative;
      width: 100%;
      max-width: 800px;
      aspect-ratio: 4/3;
      margin: 0 auto;
      background: radial-gradient(ellipse at center, var(--primary-color) 0%, var(--secondary-color) 100%);
      border: 10px solid #3e2723;
      border-radius: 50%;
      box-shadow: 0 0 50px rgba(0,0,0,0.6);
    }

    .player {
      position: absolute;
      width: 160px;
      text-align: center;
      transition: transform 0.3s ease;
    }

    .player:hover {
      transform: scale(1.05);
    }

    .player .name {
      font-weight: bold;
      margin-bottom: 5px;
      text-shadow: 1px 1px 2px black;
    }

    .hand, .discard-pile {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 5px;
      min-height: 40px;
    }

    .card {
      width: 40px;
      height: 60px;
      border-radius: 6px;
      background: white;
      border: 2px solid black;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
      cursor: pointer;
      transition: transform 0.2s ease;
      user-select: none;
    }

    .card:hover {
      transform: translateY(-10px);
    }

    .card.selected {
      transform: translateY(-20px);
      box-shadow: 0 0 10px var(--accent-color);
    }

    .card.red {
      color: red;
    }

    .card.back {
      background: #b71c1c;
      background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.1) 10px, rgba(0,0,0,0.1) 20px);
      border: none;
    }

    .discard-label {
      font-size: 0.9em;
      color: #ddd;
      margin: 4px 0 2px;
    }

    /* Player positioning */
    .player.bottom {
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
    }

    .player.top {
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
    }

    .player.left {
      top: 50%;
      left: 10px;
      transform: translateY(-50%);
    }

    .player.right {
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
    }

    /* Controls */
    .controls {
      text-align: center;
      margin-top: 15px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .controls button {
      padding: 10px 16px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background: var(--accent-color);
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    }

    .controls button:hover {
      transform: translateY(-2px);
      box-shadow: 4px 4px 8px rgba(0,0,0,0.4);
    }

    .controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      text-align: center;
      font-size: 1.1em;
      margin-bottom: 10px;
      padding: 10px;
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
    }

    /* New components */
    .game-info {
      width: 300px;
      background: rgba(0,0,0,0.7);
      border-radius: 10px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .timer {
      text-align: center;
      font-size: 1.2em;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
      overflow: hidden;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .chat-input {
      display: flex;
      padding: 10px;
      gap: 5px;
    }

    .chat-input input {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      background: rgba(255,255,255,0.9);
    }

    .chat-input button {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      background: var(--accent-color);
      cursor: pointer;
    }

    .notifications {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }

    .notification {
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Lobby styles */
    .lobby {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      z-index: 1000;
    }

    .lobby input {
      padding: 8px;
      margin: 10px;
      border-radius: 4px;
      border: none;
    }

    .lobby button {
      padding: 8px 16px;
      margin: 5px;
      border-radius: 4px;
      border: none;
      background: var(--accent-color);
      cursor: pointer;
    }

    .game-id {
      font-family: monospace;
      padding: 5px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      margin: 10px 0;
    }

    .player-list {
      margin: 15px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .player-item {
      margin: 5px 0;
      padding: 5px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    .hidden {
      display: none;
    }

    /* Responsive design */
    @media (max-width: 1200px) {
      .game-container {
        flex-direction: column;
      }

      .game-info {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
      }
    }

    @media (max-width: 600px) {
      .table {
        border-width: 5px;
      }

      .player {
        width: 120px;
      }

      .card {
        width: 30px;
        height: 45px;
        font-size: 14px;
      }

      .controls button {
        padding: 8px 12px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <h1>Pai Kang Online ðŸŽ´</h1>

  <!-- Lobby -->
  <div id="lobby" class="lobby">
    <h2>Benvenuto a Pai Kang Online</h2>
    <div id="create-game">
      <input type="text" id="player-name" placeholder="Il tuo nome">
      <button onclick="createGame()">Crea Partita</button>
    </div>
    <div id="join-game">
      <input type="text" id="game-id" placeholder="ID Partita">
      <button onclick="joinGame()">Unisciti</button>
    </div>
  </div>

  <!-- Game Container -->
  <div id="game-container" class="game-container hidden">
    <div class="main-game">
      <div class="status" id="status">In attesa dei giocatori...</div>

      <div class="table">
        <!-- Giocatore in alto -->
        <div class="player top" data-id="">
          <div class="name">Giocatore in attesa</div>
          <div class="hand" id="top-hand">
            <div class="card back"></div>
            <div class="card back"></div>
            <div class="card back"></div>
            <div class="card back"></div>
            <div class="card back"></div>
          </div>
          <div class="discard-label">Scarti</div>
          <div class="discard-pile" id="top-discard"></div>
        </div>

        <!-- Giocatore a sinistra -->
        <div class="player left" data-id="">
          <div class="name">Giocatore in attesa</div>
          <div class="hand" id="left-hand">
            <div class="card back"></div>
            <div class="card back"></div>
            <div class="card back"></div>
            <div class="card back"></div>
            <div class="card back"></div>
          </div>
          <div class="discard-label">Scarti</div>
          <div class="discard-pile" id="left-discard"></div>
        </div>

        <!-- Giocatore a destra -->
        <div class="player right" data-id="">
          <div class="name">Giocatore in attesa</div>
          <div class="hand" id="right-hand">
            <div class="card back"></div>
            <div class="card back"></div>
            <div class="card back"></div>
            <div class="card back"></div>
            <div class="card back"></div>
          </div>
          <div class="discard-label">Scarti</div>
          <div class="discard-pile" id="right-discard"></div>
        </div>

        <!-- Giocatore (tu) in basso -->
        <div class="player bottom" data-id="">
          <div class="name">Tu</div>
          <div class="hand" id="bottom-hand">
            <div class="card red">Aâ™¥</div>
            <div class="card red">8â™¦</div>
            <div class="card">9â™£</div>
            <div class="card">10â™ </div>
            <div class="card">2â™£</div>
          </div>
          <div class="discard-label">Scarti</div>
          <div class="discard-pile" id="bottom-discard"></div>
        </div>
      </div>

      <div class="controls">
        <button id="drawBtn" onclick="drawCard()">Pesca</button>
        <button id="discardBtn" onclick="discardCard()">Scarta</button>
        <button id="kangBtn" onclick="kang()">Kang</button>
        <button id="startBtn" onclick="startGame()" class="hidden">Avvia Partita</button>
      </div>
    </div>

    <div class="game-info">
      <div class="timer" id="timer">Tempo: 30s</div>
      <div class="chat-container">
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input">
          <input type="text" id="chat-input" placeholder="Scrivi un messaggio...">
          <button id="send-chat" onclick="sendChatMessage()">Invia</button>
        </div>
      </div>
    </div>
  </div>

  <div class="notifications" id="notifications"></div>

  <script>
    // Inizializzazione Socket.IO con gestione degli errori
    let socket;
    try {
      socket = io();
      console.log("Socket.IO inizializzato");
    } catch (error) {
      console.error("Errore nell'inizializzazione di Socket.IO:", error);
      showNotification("Errore di connessione al server. Ricarica la pagina.");
    }

    let gameId = null;
    let playerName = null;
    let isHost = false;
    let currentTurn = null;
    let players = [];

    // Funzioni di utilitÃ 
    function showNotification(message) {
      console.log("Notifica:", message);
      const notifications = document.getElementById('notifications');
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      notifications.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    function addChatMessage(message, sender) {
      const chatMessages = document.getElementById('chat-messages');
      const messageElement = document.createElement('div');
      messageElement.textContent = `${sender}: ${message}`;
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function updatePlayerList(playersList) {
      console.log("Aggiornamento lista giocatori:", playersList);
      players = playersList;
      
      const playerElements = {
        top: document.querySelector('.player.top'),
        left: document.querySelector('.player.left'),
        right: document.querySelector('.player.right'),
        bottom: document.querySelector('.player.bottom')
      };

      // Reset player names
      Object.values(playerElements).forEach(el => {
        if (el) {
          el.querySelector('.name').textContent = 'Giocatore in attesa';
          el.setAttribute('data-id', '');
        }
      });

      // Update player names
      playersList.forEach((player, index) => {
        const position = ['top', 'left', 'right', 'bottom'][index];
        if (playerElements[position]) {
          playerElements[position].querySelector('.name').textContent = player.name;
          playerElements[position].setAttribute('data-id', player.id);
        }
      });
    }

    // Funzioni di gioco
    function createGame() {
      playerName = document.getElementById('player-name').value.trim();
      if (!playerName) {
        showNotification('Inserisci il tuo nome');
        return;
      }
      console.log("Creazione partita con nome:", playerName);
      socket.emit('createGame', playerName);
    }

    function joinGame() {
      playerName = document.getElementById('player-name').value.trim();
      gameId = document.getElementById('game-id').value.trim();
      if (!playerName || !gameId) {
        showNotification('Inserisci nome e ID partita');
        return;
      }
      console.log("Unione alla partita:", gameId, "con nome:", playerName);
      socket.emit('joinGame', { gameId, playerName });
    }

    function startGame() {
      console.log("Avvio partita");
      socket.emit('startGame');
    }

    function drawCard() {
      if (currentTurn !== socket.id) {
        showNotification('Non Ã¨ il tuo turno');
        return;
      }
      console.log("Pesca carta");
      socket.emit('drawCard');
    }

    function discardCard() {
      if (currentTurn !== socket.id) {
        showNotification('Non Ã¨ il tuo turno');
        return;
      }
      const selectedCard = document.querySelector('.card.selected');
      if (!selectedCard) {
        showNotification('Seleziona una carta da scartare');
        return;
      }
      const cardIndex = Array.from(selectedCard.parentElement.children).indexOf(selectedCard);
      console.log("Scarta carta all'indice:", cardIndex);
      socket.emit('discardCard', cardIndex);
    }

    function kang() {
      // Implementa la logica del Kang
      showNotification('FunzionalitÃ  Kang in sviluppo');
    }

    function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (message) {
        console.log("Invio messaggio chat:", message);
        socket.emit('chatMessage', message);
        input.value = '';
      }
    }

    // Event listeners Socket.IO
    socket.on('connect', () => {
      console.log("Connesso al server con ID:", socket.id);
      showNotification("Connesso al server");
    });

    socket.on('connect_error', (error) => {
      console.error("Errore di connessione:", error);
      showNotification("Errore di connessione al server");
    });

    socket.on('gameCreated', ({ gameId: newGameId, players: playersList }) => {
      console.log("Partita creata:", newGameId, playersList);
      gameId = newGameId;
      isHost = true;
      document.getElementById('game-container').classList.remove('hidden');
      document.getElementById('lobby').classList.add('hidden');
      document.getElementById('startBtn').classList.remove('hidden');
      showNotification(`Partita creata! ID: ${gameId}`);
      updatePlayerList(playersList);
    });

    socket.on('playerJoined', ({ players: playersList }) => {
      console.log("Giocatore unito:", playersList);
      updatePlayerList(playersList);
      showNotification('Un nuovo giocatore si Ã¨ unito alla partita');
    });

    socket.on('gameStarted', ({ players: playersList, currentTurn: newCurrentTurn }) => {
      console.log("Partita avviata:", playersList, "turno di:", newCurrentTurn);
      currentTurn = newCurrentTurn;
      document.getElementById('startBtn').classList.add('hidden');
      document.getElementById('status').textContent = `Turno di ${playersList.find(p => p.id === currentTurn)?.name}`;
      updatePlayerList(playersList);
    });

    socket.on('cardDrawn', ({ playerId, currentTurn: newCurrentTurn }) => {
      console.log("Carta pescata da:", playerId, "nuovo turno:", newCurrentTurn);
      currentTurn = newCurrentTurn;
      const player = document.querySelector(`.player[data-id="${playerId}"]`);
      if (player) {
        const hand = player.querySelector('.hand');
        const card = document.createElement('div');
        card.className = 'card back';
        hand.appendChild(card);
      }
      document.getElementById('status').textContent = `Turno di ${players.find(p => p.id === currentTurn)?.name}`;
    });

    socket.on('cardDiscarded', ({ playerId, cardIndex, currentTurn: newCurrentTurn }) => {
      console.log("Carta scartata da:", playerId, "indice:", cardIndex, "nuovo turno:", newCurrentTurn);
      currentTurn = newCurrentTurn;
      const player = document.querySelector(`.player[data-id="${playerId}"]`);
      if (player) {
        const hand = player.querySelector('.hand');
        const discardPile = player.querySelector('.discard-pile');
        const card = hand.children[cardIndex];
        if (card) {
          hand.removeChild(card);
          discardPile.appendChild(card);
        }
      }
      document.getElementById('status').textContent = `Turno di ${players.find(p => p.id === currentTurn)?.name}`;
    });

    socket.on('chatMessage', ({ playerName, message }) => {
      console.log("Messaggio chat da:", playerName, ":", message);
      addChatMessage(message, playerName);
    });

    socket.on('playerLeft', ({ playerId, players: playersList }) => {
      console.log("Giocatore uscito:", playerId, "giocatori rimanenti:", playersList);
      updatePlayerList(playersList);
      showNotification('Un giocatore ha lasciato la partita');
    });

    socket.on('error', (message) => {
      console.error("Errore dal server:", message);
      showNotification(message);
    });

    // Event listeners per le carte
    document.querySelectorAll('.card').forEach(card => {
      card.addEventListener('click', () => {
        if (currentTurn === socket.id) {
          card.classList.toggle('selected');
        }
      });
    });

    // Event listener per l'invio dei messaggi chat con Enter
    document.getElementById('chat-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendChatMessage();
      }
    });
  </script>
</body>
</html>
